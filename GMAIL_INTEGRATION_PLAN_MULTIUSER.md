# Gmailé€£æºæ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»ï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œç‰ˆï¼‰

## ğŸ“‹ æ¦‚è¦

**ç›®çš„:** URLã‚’å…±æœ‰ã™ã‚Œã°ã€ã©ã‚“ãªäººã§ã‚‚è‡ªåˆ†ã®Gmailã¨é€£æºã—ã¦éŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ä½¿ãˆã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹

**é‡è¦:** è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ğŸš¨ è§£æ±ºã™ã¹ãèª²é¡Œ

### ç¾åœ¨ã®è¨ˆç”»ã®å•é¡Œ
- âŒ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼ˆä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ãŒãªã„
- âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒãªã„

### ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œã®è¦ä»¶
- âœ… å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€æ„ã«è­˜åˆ¥
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ†é›¢ä¿å­˜
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½è·¡
- âœ… ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰ˆï¼‰

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æ–¹æ³•

**é¸æŠè‚¢:**

#### A. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆæ¨å¥¨ï¼‰
- ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«ä¸€æ„ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ
- Cookieã¾ãŸã¯ LocalStorage ã«ä¿å­˜
- ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç´ä»˜ã‘

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦
- ã‚·ãƒ³ãƒ—ãƒ«
- ã™ãã«ä½¿ãˆã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- Cookieã‚¯ãƒªã‚¢ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å–ªå¤±
- ç«¯æœ«ã”ã¨ã«å†é€£æºãŒå¿…è¦

#### B. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹èªè¨¼
- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆè‡ªä½“ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ã—ã¦ä½¿ç”¨
- OAuthèªè¨¼å¾Œã€email ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã™ã‚‹

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ç«¯æœ«ãŒå¤‰ã‚ã£ã¦ã‚‚åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- å®Ÿè£…ãŒè¤‡é›‘
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ãŒå¢—ãˆã‚‹

### æ¨å¥¨: **A. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDæ–¹å¼**ï¼ˆPhase 1ï¼‰

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨ªå•]
    â†“
[ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆUUIDï¼‰]
    â†“
[Cookieã«ä¿å­˜]
    â†“
[Gmailé€£æºæ™‚: session_id + gmail_token ã‚’ä¿å­˜]
```

## ğŸ”§ å®Ÿè£…è©³ç´°

### A. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

#### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰

```javascript
// static/js/session.js
class SessionManager {
    constructor() {
        this.sessionId = this.getOrCreateSessionId();
    }

    getOrCreateSessionId() {
        // LocalStorageã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
        let sessionId = localStorage.getItem('voiceagent_session_id');

        if (!sessionId) {
            // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆUUID v4ï¼‰
            sessionId = this.generateUUID();
            localStorage.setItem('voiceagent_session_id', sessionId);
            console.log('ğŸ†• New session created:', sessionId);
        } else {
            console.log('â™»ï¸  Existing session:', sessionId);
        }

        return sessionId;
    }

    generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    getSessionId() {
        return this.sessionId;
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
window.sessionManager = new SessionManager();
```

#### 2. ã™ã¹ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å«ã‚ã‚‹

```javascript
// APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚
async function apiRequest(url, options = {}) {
    const sessionId = window.sessionManager.getSessionId();

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¿½åŠ 
    options.headers = {
        ...options.headers,
        'X-Session-ID': sessionId
    };

    return fetch(url, options);
}
```

### B. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```python
# src/middleware/session.py
from fastapi import Request, HTTPException
from typing import Optional
import os
import json

class SessionManager:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†"""

    def __init__(self):
        self.sessions_dir = "data/sessions"
        os.makedirs(self.sessions_dir, exist_ok=True)

    def get_session_id(self, request: Request) -> Optional[str]:
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—"""
        return request.headers.get('X-Session-ID')

    def validate_session_id(self, session_id: str) -> bool:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®å½¢å¼ã‚’æ¤œè¨¼"""
        if not session_id or len(session_id) != 36:
            return False
        # UUIDå½¢å¼ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
        return session_id.count('-') == 4

    def get_user_data_path(self, session_id: str, data_type: str) -> str:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ã‚¹ã‚’å–å¾—"""
        user_dir = os.path.join(self.sessions_dir, session_id)
        os.makedirs(user_dir, exist_ok=True)
        return os.path.join(user_dir, f"{data_type}.json")

    def get_gmail_token_path(self, session_id: str) -> str:
        """Gmailãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‘ã‚¹ã‚’å–å¾—"""
        return self.get_user_data_path(session_id, "gmail_token")

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
session_manager = SessionManager()
```

#### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¾å­˜æ€§ï¼ˆFastAPI Dependencyï¼‰

```python
# src/dependencies/session.py
from fastapi import Header, HTTPException

async def get_session_id(x_session_id: str = Header(None)) -> str:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—ãƒ»æ¤œè¨¼ã™ã‚‹ä¾å­˜æ€§"""
    if not x_session_id:
        raise HTTPException(
            status_code=400,
            detail="Session ID is required. Please include X-Session-ID header."
        )

    if not session_manager.validate_session_id(x_session_id):
        raise HTTPException(
            status_code=400,
            detail="Invalid session ID format"
        )

    return x_session_id
```

#### 3. Gmailèªè¨¼APIï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œç‰ˆï¼‰

```python
# src/api/gmail_auth.py
from fastapi import APIRouter, Depends, HTTPException
from fastapi.responses import HTMLResponse
from google_auth_oauthlib.flow import InstalledAppFlow
from google.oauth2.credentials import Credentials
import os

router = APIRouter()

SCOPES = [
    'https://www.googleapis.com/auth/gmail.readonly',
    'https://www.googleapis.com/auth/gmail.send',
    'https://www.googleapis.com/auth/gmail.compose'
]

# ä¸€æ™‚çš„ã«èªè¨¼ä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²ï¼ˆstate â†’ session_idï¼‰
auth_states = {}

@router.get("/api/gmail/auth/start")
async def gmail_auth_start(session_id: str = Depends(get_session_id)):
    """Gmail OAuthèªè¨¼ã‚’é–‹å§‹"""

    # èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    credentials_file = "data/gmail_credentials.json"
    if not os.path.exists(credentials_file):
        raise HTTPException(
            status_code=500,
            detail="Gmail credentials file not found. Please configure OAuth credentials."
        )

    # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIï¼ˆç’°å¢ƒã«å¿œã˜ã¦å‹•çš„ã«å¤‰æ›´ï¼‰
    app_url = os.getenv('APP_URL', 'http://localhost:8000')
    redirect_uri = f"{app_url}/api/gmail/auth/callback"

    # OAuth2ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ
    flow = Flow.from_client_secrets_file(
        credentials_file,
        scopes=SCOPES,
        redirect_uri=redirect_uri
    )

    # èªè¨¼URLã®ç”Ÿæˆ
    auth_url, state = flow.authorization_url(
        access_type='offline',
        include_granted_scopes='true',
        prompt='consent'  # å¸¸ã«åŒæ„ç”»é¢ã‚’è¡¨ç¤ºï¼ˆrefresh_tokenå–å¾—ã®ãŸã‚ï¼‰
    )

    # stateã¨session_idã‚’ç´ä»˜ã‘ï¼ˆCSRFå¯¾ç­– & ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡ï¼‰
    auth_states[state] = session_id

    return {
        "auth_url": auth_url,
        "state": state
    }


@router.get("/api/gmail/auth/callback")
async def gmail_auth_callback(code: str, state: str):
    """Gmail OAuthèªè¨¼ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""

    # stateã‹ã‚‰session_idã‚’å–å¾—
    session_id = auth_states.get(state)
    if not session_id:
        return HTMLResponse("""
            <html>
                <body>
                    <h1>ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h1>
                    <p>èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                </body>
            </html>
        """)

    try:
        # èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
        credentials_file = "data/gmail_credentials.json"
        app_url = os.getenv('APP_URL', 'http://localhost:8000')
        redirect_uri = f"{app_url}/api/gmail/auth/callback"

        flow = Flow.from_client_secrets_file(
            credentials_file,
            scopes=SCOPES,
            redirect_uri=redirect_uri,
            state=state
        )

        flow.fetch_token(code=code)
        credentials = flow.credentials

        # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ä¿å­˜
        token_path = session_manager.get_gmail_token_path(session_id)
        with open(token_path, 'w') as token_file:
            token_file.write(credentials.to_json())

        # ä½¿ç”¨æ¸ˆã¿stateã‚’å‰Šé™¤
        del auth_states[state]

        # æˆåŠŸãƒšãƒ¼ã‚¸ã‚’è¿”ã™
        return HTMLResponse("""
            <html>
                <head>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            margin: 0;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                        }
                        .container {
                            text-align: center;
                            padding: 2rem;
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            backdrop-filter: blur(10px);
                        }
                        h1 { margin: 0 0 1rem 0; }
                        .icon { font-size: 4rem; margin-bottom: 1rem; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="icon">âœ…</div>
                        <h1>Gmailé€£æºãŒå®Œäº†ã—ã¾ã—ãŸï¼</h1>
                        <p>ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <script>
                        // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æˆåŠŸã‚’é€šçŸ¥
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'gmail_auth_success',
                                sessionId: '""" + session_id + """'
                            }, '*');
                        }

                        // 2ç§’å¾Œã«è‡ªå‹•çš„ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    </script>
                </body>
            </html>
        """)

    except Exception as e:
        # ä½¿ç”¨æ¸ˆã¿stateã‚’å‰Šé™¤
        if state in auth_states:
            del auth_states[state]

        return HTMLResponse(f"""
            <html>
                <body>
                    <h1>ã‚¨ãƒ©ãƒ¼: èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ</h1>
                    <p>{str(e)}</p>
                    <button onclick="window.close()">é–‰ã˜ã‚‹</button>
                </body>
            </html>
        """)


@router.get("/api/gmail/status")
async def gmail_status(session_id: str = Depends(get_session_id)):
    """Gmailé€£æºçŠ¶æ…‹ã‚’å–å¾—"""

    token_path = session_manager.get_gmail_token_path(session_id)

    if not os.path.exists(token_path):
        return {"connected": False, "email": None}

    try:
        # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿è¾¼ã¿
        creds = Credentials.from_authorized_user_file(token_path, SCOPES)

        # ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ç¢ºèª
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                from google.auth.transport.requests import Request
                creds.refresh(Request())

                # æ›´æ–°ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                with open(token_path, 'w') as token_file:
                    token_file.write(creds.to_json())

                # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
                email = get_user_email(creds)
                return {"connected": True, "email": email}
            else:
                return {"connected": False, "email": None}

        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        email = get_user_email(creds)
        return {"connected": True, "email": email}

    except Exception as e:
        logger.error(f"Failed to check Gmail status: {e}")
        return {"connected": False, "email": None}


@router.post("/api/gmail/disconnect")
async def gmail_disconnect(session_id: str = Depends(get_session_id)):
    """Gmailé€£æºã‚’è§£é™¤"""

    token_path = session_manager.get_gmail_token_path(session_id)

    if os.path.exists(token_path):
        os.remove(token_path)

    return {"success": True, "message": "Gmailé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸ"}


def get_user_email(credentials: Credentials) -> str:
    """èªè¨¼æƒ…å ±ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—"""
    try:
        from googleapiclient.discovery import build
        service = build('gmail', 'v1', credentials=credentials)
        profile = service.users().getProfile(userId='me').execute()
        return profile.get('emailAddress', 'unknown@example.com')
    except Exception as e:
        logger.error(f"Failed to get user email: {e}")
        return 'unknown@example.com'
```

#### 4. Gmail Toolä¿®æ­£ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰

```python
# src/tools/gmail_tool.py ã®ä¿®æ­£

class GmailTool(Tool):
    def __init__(self, session_id: str = None):
        super().__init__()
        self.session_id = session_id  # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä¿æŒ
        # ... æ—¢å­˜ã®å®Ÿè£… ...

    async def _authenticate(self, session_id: str = None) -> bool:
        """Gmail APIèªè¨¼ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰"""
        try:
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
            if session_id:
                self.session_id = session_id

            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ã‚¹ã‚’å–å¾—
            if self.session_id:
                self.token_file = session_manager.get_gmail_token_path(self.session_id)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆRailwayå¯¾å¿œï¼‰
                self.token_file = "data/gmail_token.json"

            # æ—¢å­˜ã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
            # ...
```

### C. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£

#### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¿½åŠ 

```javascript
// app.js ã®åˆæœŸåŒ–éƒ¨åˆ†
async init() {
    try {
        console.log('Initializing Voice Agent...');

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®åˆæœŸåŒ–ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
        if (!window.sessionManager) {
            window.sessionManager = new SessionManager();
        }

        // UIã®åˆæœŸåŒ–
        await this.uiManager.init();
        // ... æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
    }
}
```

#### 2. APIå‘¼ã³å‡ºã—ã®ä¿®æ­£

```javascript
// ã™ã¹ã¦ã®fetchå‘¼ã³å‡ºã—ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
async apiRequest(url, options = {}) {
    const sessionId = window.sessionManager.getSessionId();

    options.headers = {
        ...options.headers,
        'X-Session-ID': sessionId
    };

    return fetch(url, options);
}

// ä½¿ç”¨ä¾‹
async showGmailInfo() {
    const response = await this.apiRequest('/api/gmail/status');
    const data = await response.json();
    // ...
}
```

### D. ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
data/
â”œâ”€â”€ gmail_credentials.json (å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å…±é€šã®OAuthè¨­å®š)
â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ 12345678-abcd-4ef0-9012-345678901234/  (ãƒ¦ãƒ¼ã‚¶ãƒ¼A)
â”‚   â”‚   â”œâ”€â”€ gmail_token.json
â”‚   â”‚   â””â”€â”€ personal_memory.json
â”‚   â”œâ”€â”€ 87654321-dcba-4fe0-2109-876543210987/  (ãƒ¦ãƒ¼ã‚¶ãƒ¼B)
â”‚   â”‚   â”œâ”€â”€ gmail_token.json
â”‚   â”‚   â””â”€â”€ personal_memory.json
â”‚   â””â”€â”€ ...
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯å¯¾ç­–
- ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’HTTPSçµŒç”±ã§ã®ã¿é€ä¿¡
- ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®å½¢å¼æ¤œè¨¼

### 2. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯ `sessions/A/` ã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã¯ `sessions/B/` ã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã‚’é˜²ã

### 3. ãƒˆãƒ¼ã‚¯ãƒ³ä¿è­·
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ `0600`
- `.gitignore` ã« `data/sessions/` ã‚’è¿½åŠ 

## ğŸ“ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 1: ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†åŸºç›¤
1. `SessionManager` ã‚¯ãƒ©ã‚¹å®Ÿè£…ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
3. ã™ã¹ã¦ã®APIå‘¼ã³å‡ºã—ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDè¿½åŠ 

### ã‚¹ãƒ†ãƒƒãƒ—2: Gmailèªè¨¼APIï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰ˆï¼‰
1. `/api/gmail/auth/start` - state ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®ç´ä»˜ã‘
2. `/api/gmail/auth/callback` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜
3. `/api/gmail/status` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª
4. `/api/gmail/disconnect` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤

### ã‚¹ãƒ†ãƒƒãƒ—3: Gmail Toolä¿®æ­£
1. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å—ã‘å–ã‚‹
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ã‚¹ã‚’ä½¿ç”¨
3. ç’°å¢ƒå¤‰æ•°ã¨ã®ä½µç”¨ï¼ˆRailwayå¯¾å¿œç¶­æŒï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆ
1. è¤‡æ•°ãƒ–ãƒ©ã‚¦ã‚¶/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆ
2. ç•°ãªã‚‹Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§åŒæ™‚é€£æº
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç‹¬ç«‹æ€§ã‚’ç¢ºèª

## âœ… ã“ã‚Œã§å®Ÿç¾ã§ãã‚‹ã“ã¨

### ã‚·ãƒŠãƒªã‚ª1: ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒã‚¢ã‚¯ã‚»ã‚¹
```
1. https://your-app.railway.app ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ: session-A
3. Gmailã¨é€£æº: account-A@gmail.com
4. ãƒ¡ãƒ¼ãƒ«ä¸€è¦§: account-Aã®ãƒ¡ãƒ¼ãƒ«ã®ã¿è¡¨ç¤º
```

### ã‚·ãƒŠãƒªã‚ª2: ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒã‚¢ã‚¯ã‚»ã‚¹ï¼ˆåŒæ™‚ï¼‰
```
1. https://your-app.railway.app ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ: session-B
3. Gmailã¨é€£æº: account-B@gmail.com
4. ãƒ¡ãƒ¼ãƒ«ä¸€è¦§: account-Bã®ãƒ¡ãƒ¼ãƒ«ã®ã¿è¡¨ç¤º
```

### çµæœ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼A ã¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼B ã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«åˆ†é›¢
- âœ… URLã‚’å…±æœ‰ã™ã‚‹ã ã‘ã§èª°ã§ã‚‚åˆ©ç”¨å¯èƒ½
- âœ… å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®Gmailã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤è€ƒæ…®äº‹é …

### Google Cloud Consoleè¨­å®š
- **é‡è¦:** OAuthåŒæ„ç”»é¢ã‚’ã€Œå…¬é–‹ã€ã«è¨­å®š
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIè¿½åŠ :
  - `http://localhost:8000/api/gmail/auth/callback` (é–‹ç™º)
  - `https://your-app.railway.app/api/gmail/auth/callback` (æœ¬ç•ª)

### Railwayç’°å¢ƒå¤‰æ•°
```bash
APP_URL=https://your-app.railway.app
```

## ğŸ¯ çµè«–

**å…ƒã®è¨ˆç”»ï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰:** âŒ è¤‡æ•°äººã§ä½¿ãˆãªã„

**ä¿®æ­£ç‰ˆï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰:** âœ… URLã‚’å…±æœ‰ã™ã‚Œã°èª°ã§ã‚‚è‡ªåˆ†ã®Gmailã§ä½¿ãˆã‚‹

ã“ã®ä¿®æ­£ç‰ˆã§å®Ÿè£…ã™ã‚Œã°ã€è¦ä»¶ã‚’æº€ãŸã›ã¾ã™ï¼
